apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "gp-multena.name" . }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "gp-multena.labels" . | nindent 4 }}
data:
  config.yaml: |-
    log:
      level: {{ .Values.multena.log.level }}
      log_tokens: {{ .Values.multena.log.logTokens }}
    tenant_provider: {{ .Values.multena.provider }}
    web:
      proxy_port: {{ .Values.service.webPort }}
      metrics_port: {{ .Values.service.metricsPort }}
      host: {{ .Values.multena.web.host }}
      insecure_skip_verify: false
      trusted_root_ca_path: {{ .Values.multena.web.trustedRootCaPath }}
      jwks_cert_url: {{ .Values.multena.jwksCertUrl }}
    admin:
      bypass: {{ .Values.multena.admin.bypass }}
      group: {{ .Values.multena.admin.group }}
    dev:
      enabled: false
      username: ""
      service_account_token: ""
    {{- if .Values.multena.db.enabled }}
    db:
      enabled: true
      user: {{ .Values.multena.db.user }}
      password_path: {{ .Values.multena.db.passwordPath }}
      host: {{ .Values.multena.db.host }}
      port: {{ .Values.multena.db.port }}
      dbName: {{ .Values.multena.db.dbName }}
      query: {{ .Values.multena.db.query }}
    {{- end }}
    thanos:
      url: {{ .Values.multena.thanos.url }}
      tenant_label: {{ .Values.multena.thanos.tenantLabel }}
      cert: "/etc/secrets/thanos/cert.pem"
      key: "/etc/secrets/thanos/key.pem"
    loki:
      url: {{ .Values.multena.loki.url }}
      tenant_label: {{ .Values.multena.loki.tenantLabel }}
      cert: "/etc/secrets/loki/cert.pem"
      key: "/etc/secrets/loki/key.pem"


---
{{- if eq .Values.multena.provider "configmap" }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "gp-multena.name" . }}-labels
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "gp-multena.labels" . | nindent 4 }}
data:
  labels.yaml: |-
    users:
      - example_user: [ "example_namespace" ]
    groups:
      - example_group: ["example_namespace"]
{{- end }}