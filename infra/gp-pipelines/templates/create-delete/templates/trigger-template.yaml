apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: create-template
  namespace: {{ .Release.Namespace }}

spec:
  params:
    - name: repo
      description: The git repo
    - name: branch
      description: The git branch
  resourcetemplates:
    - apiVersion: tekton.dev/v1beta1
      kind: PipelineRun
      metadata:
        generateName: "git-demo-microservice-"
      spec:
        taskRunSpecs:
          - pipelineTaskName: create-task # ...your git-clone PipelineTask name...
            taskPodTemplate:
              securityContext:
                runAsNonRoot: true
        serviceAccountName: new-repo-sa
        pipelineRef:
          name: create-pipeline
        params:
          - name: branch
            value: $(tt.params.branch)
          - name: repo
            value: $(tt.params.repo)
        workspaces:
          - name: mnt
            volumeClaimTemplate:
              spec:
                accessModes:
                  - ReadWriteOnce
                resources:
                  requests:
                    storage: 300Mi
                volumeMode: Filesystem
          - name: ssh-key
            secret:
              secretName: tomeindl-ssh
---
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: delete-template
  namespace: {{ .Release.Namespace }}
spec:
  params:
    - name: repo
      description: The git repo
    - name: branch
      description: The git branch
  resourcetemplates:
    - apiVersion: tekton.dev/v1beta1
      kind: PipelineRun
      metadata:
        generateName: "git-demo-microservice-"
      spec:
        serviceAccountName: new-repo-sa
        pipelineRef:
          name: delete-pipeline
        params:
          - name: branch
            value: $(tt.params.branch)
          - name: repo
            value: $(tt.params.repo)
        workspaces:
          - name: mnt
            volumeClaimTemplate:
              spec:
                accessModes:
                  - ReadWriteOnce
                resources:
                  requests:
                    storage: 300Mi
                volumeMode: Filesystem
          - name: ssh-key
            secret:
              secretName: tomeindl-ssh

---
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerBinding
metadata:
  name: create-delete-trigger
  namespace: {{ .Release.Namespace }}

spec:
  params:
    - name: repo
      value: $(body.repository.name)
    - name: branch
      value: $(body.ref)
---
apiVersion: triggers.tekton.dev/v1beta1
kind: EventListener
metadata:
  name: create-eventlistener
  namespace: {{ .Release.Namespace }}

spec:
  triggers:
    - name: create-workflow
      interceptors:
        - ref:
            name: "github"
            kind: ClusterInterceptor
            apiVersion: triggers.tekton.dev
          params:
            - name: "secretRef"
              value:
                secretName: create-workflow-ssh
                secretKey: git-hook
            - name: "eventTypes"
              value: [ "create" ]
      bindings:
        - ref: create-delete-trigger
      template:
        ref: create-template
    - name: delete-workflow
      interceptors:
        - ref:
            name: "github"
            kind: ClusterInterceptor
            apiVersion: triggers.tekton.dev
          params:
            - name: "secretRef"
              value:
                secretName: create-workflow-ssh
                secretKey: git-hook
            - name: "eventTypes"
              value: [ "delete" ]
      bindings:
        - ref: create-delete-trigger
      template:
        ref: delete-template
---
kind: Pipeline
apiVersion: tekton.dev/v1beta1
metadata:
  name: create-pipeline
  namespace: {{ .Release.Namespace }}
spec:
  params:
    - name: repo
      type: string
    - name: branch
      type: string
  workspaces:
    - name: ssh-key
    - name: mnt
  tasks:
    - name: create-task
      taskRef:
        name: create-repository
      params:
        - name: repo
          value: $(params.repo)
        - name: branch
          value: $(params.branch)
      workspaces:
        - name: ssh-key
          workspace: ssh-key
        - name: mnt
          workspace: mnt
---
kind: Pipeline
apiVersion: tekton.dev/v1beta1
metadata:
  name: delete-pipeline
  namespace: {{ .Release.Namespace }}
spec:
  params:
    - name: repo
      type: string
    - name: branch
      type: string
  workspaces:
    - name: ssh-key
    - name: mnt
  tasks:
    - name: delete-task
      taskRef:
        name: delete-branch
      params:
        - name: repo
          value: $(params.repo)
        - name: branch
          value: $(params.branch)
      workspaces:
        - name: ssh-key
          workspace: ssh-key
        - name: mnt
          workspace: mnt


