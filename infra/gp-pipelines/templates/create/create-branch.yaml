apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: create-repository
  namespace: gp-pipelines
spec:
  params:
    - name: repo
      type: string
    - name: branch
      type: string
  ##results:
  ##  - name: namespace
  ##    description: Name of the created namespace
  steps:
    - name: create-ns
      image: docker.io/bitnami/kubectl
      script: |
        cat <<EOF | kubectl create -f -
        kind: Namespace
        apiVersion: v1
        metadata:
          name: $(params.repo)-$(params.branch)
          labels:
            argocd.argoproj.io/managed-by: gepaplexx-cicd-tools
        EOF

    - name: add-image-puller-to-default-sa
      image: docker.io/bitnami/kubectl
      script: >
        kubectl create rolebinding default-pull-images
        --role system:image-puller
        --serviceaccount $(params.repo)-$(params.branch):default
        -n $(params.repo)-$(params.branch)
