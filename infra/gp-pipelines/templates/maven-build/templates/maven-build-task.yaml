apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: maven-build
  namespace: {{ .Release.Namespace }}
spec:
  steps:
    - name: build
      image: ghcr.io/gepaplexx/maven:$(params.maven-version)
      script: |-
        #!/usr/bin/env sh
        mvn -v
        /usr/bin/mvn-wrapper.sh clean install \
          -f /app/pom.xml \
          -Dmaven.repo.local=/cache/$(params.repo)/$(params.branch)
    - name: junit
      image: ghcr.io/gepaplexx/maven:$(params.maven-version)
      script: |-
        #!/usr/bin/env sh
        /usr/bin/mvn-wrapper.sh \
          surefire-report:report-only site -DgenerateReports=false -DoutputName=index \
          -f /app/pom.xml \
          -Dmaven.repo.local=/cache/$(params.repo)/$(params.branch)
    - name: sonar
      image: ghcr.io/gepaplexx/maven:$(params.maven-version)
      script: |-
        #!/usr/bin/env sh
        echo ${SONAR_TOKEN}
        /usr/bin/mvn-wrapper.sh \
          sonar:sonar \
          -Dsonar.login=${SONAR_TOKEN} \
          -Dsonar.host.url=$(params.sonar-host) \
          -Dsonar.verbose=true \
          -f /app/pom.xml \
          -Dmaven.repo.local=/cache/$(params.repo)/$(params.branch)
      env:
        - name: SONAR_TOKEN
          valueFrom:
            secretKeyRef:
              key: sonar-token
              name: sonar-login

  workspaces:
    - name: input
      description: Image with source code
      mountPath: /app
    - name: cache
      description: Cache for maven dependencies
      mountPath: /cache
    - name: sonar-cache
      description: Cache for sonarqube
      mountPath: /.sonar
  params:
    - name: repo
      type: string
    - name: branch
      type: string
    - name: sonar-host
      type: string
      default: http://cluster-sonarqube.gepaplexx-cicd-tools.svc.cluster.local
    - name: maven-version
      type: string
      default: latest


