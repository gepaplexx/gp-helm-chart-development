apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: create-repository
  namespace: gp-pipelines
spec:
  params:
    - name: repo
      type: string
    - name: branch
      type: string
    - name: token
      type: string
  steps:
    - image: registry.redhat.io/ubi7/ubi-minimal

      script: |-
      #!/usr/bin/env sh
      oc login
      env:
      - name: SERVICE_ACCOUNT_TOKEN
        valueFrom:
          secretKeyRef:
            name: new-repo-sa-token
            key: token
---
kind: ServiceAccount
apiVersion: v1
metadata:
  name: new-repo-sa
  namespace: gp-pipelines
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: create-ns
rules:
  - verbs:
      - create
      - get
    resources:
      - namespaces
    apiGroups:
      - ""
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: repo-sa-create-ns
roleRef:
  kind: ClusterRole
  apiGroup: rbac.authorization.k8s.io
  name: create-ns
subjects:
  - kind: ServiceAccount
    name: new-repo-sa
    namespace: gp-pipelines
---
# static secret to have a token with cluster admin rights
apiVersion: v1
kind: Secret
metadata:
  name: new-repo-sa-token
  namespace: gp-pipelines
  annotations:
    kubernetes.io/service-account.name: new-repo-sa
type: kubernetes.io/service-account-token
