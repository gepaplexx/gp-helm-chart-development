apiVersion: argoproj.io/v1alpha1
kind: ClusterWorkflowTemplate
metadata:
  name: template-java-ci-workflow
spec:
  arguments:
    parameters:
    - name: repo
      value: comes-from-caller
    - name: revision
      value: comes-from-caller
    - name: reponame
      value: comes-from-caller
#  podGC:                          #TODO: ordentliche GC konfiguration
#    strategy: OnPodCompletion
  volumeClaimTemplates:
    - metadata:
        name: workspace
      spec:
        resources:
          requests:
            storage: 500M
        accessModes: ["ReadWriteOnce"]
  serviceAccountName: operate-workflow-sa
  templates:
  - name: pipeline
    steps:
    - - arguments:
          parameters:
          - name: revision
            value: '{{ workflow.parameters.revision }}'
        name: parse-branch
        templateRef:
          clusterScope: true
          name: template-git-operations
          template: parse-branch
    - - arguments:
          parameters:
          - name: repository
            value: '{{ workflow.parameters.repo }}'
          - name: branch
            value: '{{ steps.parse-branch.outputs.branch }}'
          - name: reponame
            value: '{{ workflow.parameters.reponame }}'
        name: git-checkout
        templateRef:
          clusterScope: true
          name: template-git-operations
          template: git-checkout
    - - arguments:
          parameters:
          - name: reponame
            value: '{{ workflow.parameters.reponame }}'
        name: extract-git-commit
        templateRef:
          clusterScope: true
          name: template-git-operations
          template: extract-git-commit
    - - name: extract-namespace
        templateRef:
          clusterScope: true
          name: template-kubernetes-operations
          template: extract-namespace
    - - arguments:
          parameters:
          - name: working-directory
            value: '{{ workflow.parameters.reponame }}'
          - name: mvn-image
            value: maven:3.8.4-jdk-11
          - name: mvn-action
            value: clean package -DskipTests
        name: build-application
        templateRef:
          clusterScope: true
          name: template-maven-operations
          template: mvn
    - - arguments:
          parameters:
          - name: tag
            value: '{{ steps.extract-git-commit.outputs.commit-hash }}'
          - name: namespace
            value: '{{ steps.extract-namespace.outputs.namespace }}'
          - name: reponame
            value: '{{ workflow.parameters.reponame }}'
          - name: containerfile
            value: Containerfile
        name: build-push-image
        templateRef:
          clusterScope: true
          name: template-image-operations
          template: kaniko-image-build
    - - arguments:
          parameters:
          - name: tag
            value: '{{ steps.extract-git-commit.outputs.commit-hash }}'
          - name: reponame
            value: '{{ workflow.parameters.reponame }}'
        name: update-argocd-application
        templateRef:
          clusterScope: true
          name: template-argocd-operations
          template: update-argocd-application
  ttlStrategy:
    secondsAfterCompletion: 86400
