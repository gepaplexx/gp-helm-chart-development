####################
#### VARIABLES #####
####################
argo_workflows_db: &argo_workflows_db "argo_workflows"
argo_workflows_db_secret: &argo_workflows_db_secret "gepaplexx-cicd-tools-postgresql"
argo_workflows_db_host: &argo_workflows_db_host "argo-workflows-postgres"

####################
## SEALED SECRETS ##
####################
sealedSecret:
  postgresql:
    postgres-password: ""
    password: ""
    username: ""

####################
##  ARGO  EVENTS  ##
####################
argo_events:
  enabled: true
  fullnameOverride: argo-events
  openshift: true
  crds:
    install: false
  controller:
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 250m
        memory: 256Mi
  configs:
    nats:
      versions:
       - version: 0.22.1
         natsStreamingImage: nats-streaming:0.22.1
         metricsExporterImage: natsio/prometheus-nats-exporter:0.8.0
    jetstream:
      versions: # Ã¼bernommen aus den auskommentierten default-values
       - version: latest
         natsImage: nats:2.8.2
         metricsExporterImage: natsio/prometheus-nats-exporter:0.9.1
         configReloaderImage: natsio/nats-server-config-reloader:0.7.0
         startCommand: /nats-server
       - version: "2.8.2"
         natsImage: nats:2.8.2
         metricsExporterImage: natsio/prometheus-nats-exporter:0.9.1
         configReloaderImage: natsio/nats-server-config-reloader:0.7.0
         startCommand: /nats-server
       - version: 2.8.2-alpine
         natsImage: nats:2.8.2-alpine
         metricsExporterImage: natsio/prometheus-nats-exporter:0.9.1
         configReloaderImage: natsio/nats-server-config-reloader:0.7.0
         startCommand: nats-server

####################
## ARGO WORFKLOWS ##
####################
argo_workflows:
  enabled: true
  images:
    tag: v3.4.0 # Delete this line after new Helm Chart vor 3.4.0 is released
    pullPolicy: IfNotPresent

  rbac:
    sudoGroup: Gepaplexx
    clusterscoped:
      developerGroup: Gepardec
      enabled: false
    defaultRead: true
    clientSecret: "" # SealedsecretEncrypted ClientSecret
    clientId: "argo-workflows"
  fullnameOverride: argo-workflows
  server:
    extraArgs:
      - "--auth-mode=sso"
      - "--auth-mode=client"
    extraEnv:
      - name: "SSO_DELEGATE_RBAC_TO_NAMESPACE"
        value: "true"
    # sso configuration:
    sso:
      issuer: "https://sso.apps.clustername.example.com/realms/internal"
      redirectUrl: "https://workflows.example.com/oauth2/callback"
      clientSecret:
        name: argo-workflows-sso
        key: client-secret
      clientId:
        name: argo-workflows-sso
        key: client-id
      rbac:
        enabled: true
    ingress:
      enabled: true
      hosts:
        - workflows.example.com
      ingressClassName: "openshift-default"
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt
      tls:
        - hosts:
            - workflows.example.com
          secretName: workflows.example.com-tls
    resources:
      limits:
        cpu: 500m
        memory: 256Mi
      requests:
        cpu: 250m
        memory: 128Mi

  mainContainer:
    resources:
      requests:
        cpu: 250m
        memory: 512Mi
      limits:
        cpu: 1
        memory: 4Gi

  controller:
    parallelism: 10 # 10 workflows can be executed at the same time cluster-wide
    namespaceParallelism: 5 # only 5 workflows per namespace can be executed in parallel
    nodeStatusOffLoad: false
    workflowDefaults:
      metadata:
        annotations:
          argo: workflows
      spec:
        ttlStrategy:
            secondsAfterCompletion: 3600 # delete workflows after 1 hour. they are still available in the archive
    workflowRestrictions:
      templateReferencing: Strict # only workflows using workflowTemplateRef will be executed
    resources:
      limits:
        cpu: 500m
        memory: 256Mi
      requests:
        cpu: 250m
        memory: 128Mi

    persistence:
      archive: true
      nodeStatusOffLoad: true # if true node status is only saved to the persistence DB to avoid the 1MB limit in etcd
      archiveTTL: 120d
      postgresql:
        host: *argo_workflows_db_host
        port: 5432
        database: *argo_workflows_db
        tableName: argo_workflows
        userNameSecret:
          name: *argo_workflows_db_secret
          key: username
        passwordSecret:
          name: *argo_workflows_db_secret
          key: password

  archive:
    enabled: true
    secretkey: ""
  useDefaultArtifactRepo: true
  artifactRepository:
    archiveLogs: true
    s3:
      accessKeySecret:
        name: minio-artifact-repository
        key: accesskey
      secretKeySecret:
        name: minio-artifact-repository
        key: secretkey
      insecure: true
      bucket: argo-workflows
      endpoint: minio-artifact-repository.gepaplexx-cicd-tools:9000

    metricsConfig:
      enabled: true

    serviceMonitor:
      enabled: true

  workflow:
    serviceAccount:
      create: true
      name: operate-workflow-sa

#####################
## Workflows Minio ##
#####################
minio:
  existingSecret: "minio-artifact-repository"
  securityContext:
    runAsUser: 0
  fullnameOverride: minio-artifact-repository
  replicas: 1
  persistence:
    size: 25Gi
  resources:
    requests:
      memory: 2Gi #default 4Gi bei 500Gi persistent storage. Sollte mit weniger auch auskommen.
  defaultBucket:
    enabled: true
    name: argo-workflows
  makeBucketJob:
    securityContext:
      enabled: true
      runAsUser: 0
  serviceAccount:
    name: minio

####################
##    ARGO  CD    ##
####################
argocd:
  enabled: true
  route:
    hostname: "argocd.example.com"
  applicationset:
    resources:
      limits:
        cpu: "1"
        memory: 1Gi
      requests:
        cpu: 250m
        memory: 512Mi
  controller:
    resources:
      limits:
        cpu: "1"
        memory: 2Gi
      requests:
        cpu: 250m
        memory: 512Mi
  dex:
    resources:
      limits:
        cpu: 500m
        memory: 256Mi
      requests:
        cpu: 250m
        memory: 128Mi
  redis:
    resources:
      limits:
        cpu: 500m
        memory: 1Gi
      requests:
        cpu: 250m
        memory: 128Mi
  repo:
    resources:
      limits:
        cpu: 500m
        memory: 256Mi
      requests:
        cpu: 250m
        memory: 128Mi
  server:
    resources:
      limits:
        cpu: 500m
        memory: 256Mi
      requests:
        cpu: 250m
        memory: 128Mi
  rbac:
    defaultPolicy: ''
    policies:
      - 'p, role:gepardec-admin, applications, *, *, allow'
      - 'p, role:gepardec-admin, repositories, *, *, allow'
      - 'p, role:gepardec-admin, projects, *, *, allow'
      - 'g, Gepaplexx, role:admin'
      - 'g, Gepardec, role:gepardec-admin'

######################
##    Postgresql    ##
######################
postgresql:
  enabled: true
  fullnameOverride: *argo_workflows_db_host
  service:
    ports:
      postgresql: 5432
  auth:
    username: argo_workflow
    database: *argo_workflows_db
    password: ""
    existingSecret: *argo_workflows_db_secret
  primary:
    podSecurityContext:
      enabled: false
    containerSecurityContext:
      enabled: false
