apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "gp-gchat-alert.labels" . | nindent 4 }}
data:
  {{- range $key, $value := .Values.templates }}
  {{ $key }}: |-
    {{- $value | nindent 4 }}
  {{- end }}
  config.toml: |
    # All timeouts and durations are in milliseconds.

    [app]
    address = {{ .Values.app.address | quote }}
    server_timeout = {{ .Values.app.server_timeout | quote }}
    enable_request_logs = {{ .Values.app.enable_request_logs | quote }}
    log = {{ .Values.app.log | quote }}

    {{- range $key, $value := .Values.additionalProviders }}
    [providers.{{ $key }}]
    type = {{ $value.type | default "google_chat" | quote }}
    endpoint = {{ required "setting a endpoint for providers is requiered" $value.endpoint | quote }}
    max_idle_conns = {{ $value.max_idle_conns | default "50" }}
    timeout = {{ $value.timeout | default "30s" | quote }}
    proxy_url = {{ $value.proxy_url | default "" | quote }}
    template = {{ $value.template | default "static/message.tmpl" | quote }}
    thread_ttl = {{ $value.thread_ttl | default "12h" | quote }}
    dry_run = {{ $value.dry_run | default "false" | quote }}
    {{- end }}

    {{- if .Values.buildAlerts.endpoint }}
    [providers.buildAlerts]
    type = "google_chat"
    endpoint = {{ .Values.buildAlerts.endpoint | quote }}
    max_idle_conns = {{ .Values.buildAlerts.max_idle_conns | default "50" }}
    timeout = {{ .Values.buildAlerts.timeout | default "30s" | quote }}
    thread_ttl = {{ .Values.buildAlerts.thread_ttl | default "2h" | quote }}
    template = "static/buildAlert.tmpl"
    dry_run = {{ .Values.buildAlerts.dry_run | default "false" | quote }}
    {{- end }}
